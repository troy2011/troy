// Backup of corrupted file (auto-saved by Codex CLI).
// Original path: public/WorldMapScene.js
// Saved at: 2025-12-15

import * as Phaser from 'phaser';
import { RACE_COLORS } from 'config';
import { getFirestore, collection, getDocs, doc, updateDoc } from 'firebase/firestore';
import { geohashForLocation, geohashQueryBounds } from 'geofire-common';
import * as Ship from './js/ship.js';

// ========================================
// 定数定義
// ========================================

const GAME_CONFIG = {
    GRID_SIZE: 32,
    MAP_TILE_SIZE: 500,
    METERS_PER_TILE: 100,
    SHIP_VISION_RANGE: 300,
    SHIP_SPEED: 100,
    SHIP_MOVE_COOLDOWN: 500,
    MESSAGE_DISPLAY_DURATION: 2000,
    MINIMAP_SIZE: 150,
    MINIMAP_PADDING: 10,
    SHIP_QUERY_UPDATE_INTERVAL: 1000,
    SHIP_QUERY_REFRESH_THRESHOLD: 0.25,
    CONSTRUCTION_BOUNCE_DURATION: 1000,
    CONSTRUCTION_CRANE_ROTATION: 2000,
    PARTICLE_LIFESPAN: 1000,
    PARTICLE_FREQUENCY: 500,
    FOG_ALPHA: 0.8,
    FOG_STEPS: 50,
    DEPTH: {
        SEA: 0, ISLAND: 1, SHIP: 2, BUILDING: 3, CONSTRUCTION: 4, NAME_TEXT: 10,
        INTERACTIVE_ZONE: 100, FOG: 999, MESSAGE: 1000, MINIMAP_BG: 1001,
        MINIMAP_TEXTURE: 1002, MINIMAP_MARKER: 1003
    }
};

const ISLAND_LAYOUTS = {
    small: { tiles: [[1, 2, 3], [4, 5, 6], [7, 8, 9]], width: 3, height: 3, slots: { width: 1, height: 1, offsetX: 1, offsetY: 1 } },
    medium: { tiles: [[1, 2, 2, 3], [4, 5, 5, 6], [7, 8, 8, 9]], width: 4, height: 3, slots: { width: 2, height: 1, offsetX: 1, offsetY: 1 } },
    large: { tiles: [[1, 2, 2, 3], [4, 5, 5, 6], [4, 5, 5, 6], [7, 8, 8, 9]], width: 4, height: 4, slots: { width: 2, height: 2, offsetX: 1, offsetY: 1 } },
    giant: { tiles: [[1, 2, 2, 2, 3], [4, 5, 5, 5, 6], [4, 5, 5, 5, 6], [4, 5, 5, 5, 6], [7, 8, 8, 8, 9]], width: 5, height: 5, slots: { width: 3, height: 3, offsetX: 1, offsetY: 1 } }
};

const BUILDING_DEFINITIONS = {
    17: { width: 1, height: 1 },
    22: { width: 1, height: 2 },
};

export default class WorldMapScene extends Phaser.Scene {
    constructor() {
        super('WorldMapScene');
        this.gridSize = GAME_CONFIG.GRID_SIZE;
        this.TILE_SIZE = GAME_CONFIG.GRID_SIZE;
        this.mapTileSize = GAME_CONFIG.MAP_TILE_SIZE;
        this.mapPixelSize = this.mapTileSize * this.gridSize;
        this.metersPerTile = GAME_CONFIG.METERS_PER_TILE;
        this.islandObjects = new Map();
        this.shipTween = null;
        this.playerInfo = { playFabId: null, race: null };
        this.shipVisionRange = GAME_CONFIG.SHIP_VISION_RANGE;
        this.shipSpeed = GAME_CONFIG.SHIP_SPEED;
        this.canMove = true;
        this.moveCooldown = GAME_CONFIG.SHIP_MOVE_COOLDOWN;
        this.shipMoving = false;
        this.shipTargetX = 0;
        this.shipTargetY = 0;
        this.shipTargetIsland = null;
        this.shipArrivalTimer = null;
        this.collidingIsland = null;
        this.commandMenuOpen = false;
        this.firestore = null;
        this.otherShips = new Map();
        this.shipsUnsubscribe = null;
        this.shipGeoUnsubscribes = [];
        this.lastShipQueryCenter = null;
        this.lastShipQueryUpdate = 0;
        this.shipCollisionRadius = 20;
        this.lastRamDamageAt = new Map();
        this.boardingButton = null;
        this.boardingTargetId = null;
        this.boardingVisible = false;
        this.constructionSprites = [];
        this.constructionUnsubscribe = null;
        this.demolishedSprites = [];
        this.demolishedUnsubscribe = null;
        this.shipAnims = {};
    }

    preload() {
        this.load.spritesheet('ship_sprite', 'Sprites/Ships/ships.png', { frameWidth: 32, frameHeight: 32 });
        this.load.spritesheet('guild_ship_sprite', 'Sprites/Ships/GuildShips.png', { frameWidth: 48, frameHeight: 48 });
        this.load.spritesheet('map_tiles', 'Sprites/Map/map.png', { frameWidth: 32, frameHeight: 32 });
    }

    init(data) {
        if (data && data.playFabId) {
            this.playerInfo = data;
        } else if (window.__phaserPlayerInfo && window.__phaserPlayerInfo.playFabId) {
            this.playerInfo = window.__phaserPlayerInfo;
        } else {
            this.playerInfo = { playFabId: null, race: null };
        }
        console.log('[WorldMapScene] Final playerInfo:', this.playerInfo);
    }

    async create() {
        // 背景設宁E        const seaBackground = this.add.tileSprite(0, 0, this.mapPixelSize, this.mapPixelSize, 'map_tiles', 0).setOrigin(0, 0).setDepth(GAME_CONFIG.DEPTH.SEA);
        this.seaBackground = seaBackground;
        seaBackground.setInteractive(new Phaser.Geom.Rectangle(0, 0, this.mapPixelSize, this.mapPixelSize), Phaser.Geom.Rectangle.Contains);
        seaBackground.on('pointerup', (pointer) => {
            if (this.commandMenuOpen || (typeof document !== 'undefined' && document.querySelector('.building-bottom-sheet.active'))) return;
            const worldPoint = this.cameras.main.getWorldPoint(pointer.x, pointer.y);
            this.moveShipTo(worldPoint.x, worldPoint.y, null);
        });

        // プレイヤーの船を�E置
        this.playerShip = this.physics.add.sprite(400, 300, 'ship_sprite');
        this.playerShip.setFrame(1);
        this.playerShip.setDepth(GAME_CONFIG.DEPTH.SHIP);
        this.playerShip.body.setSize(24, 24).setCollideWorldBounds(true);
        this.playerShip.clearTint();

        // カメラ設宁E        this.cameras.main.setBounds(0, 0, this.mapPixelSize, this.mapPixelSize);
        this.cameras.main.startFollow(this.playerShip, true, 0.1, 0.1);

        // UI要素作�E
        this.fogGraphics = this.add.graphics().setDepth(GAME_CONFIG.DEPTH.FOG).setScrollFactor(0);
        this.messageText = this.add.text(this.cameras.main.width / 2, this.cameras.main.height - 80, '', { fontSize: '18px', fill: '#ffffff', backgroundColor: '#000000', padding: { x: 10, y: 5 }, align: 'center' }).setOrigin(0.5).setScrollFactor(0).setDepth(GAME_CONFIG.DEPTH.MESSAGE).setVisible(false);
        this.createBoardingButton();

        // 島とマップ�E初期匁E        await this.initializeIslands();
        this.createMinimap();
        this.initializeFirestore();
    }

    generateShipAnims(baseFrame, keySuffix) {
        if (this.shipAnims[keySuffix]) return;
        console.log(`[Anims] Generating animations for ship type ${keySuffix} with baseFrame ${baseFrame}`);
        const sheet = 'ship_sprite', sheetCols = 32, baseRow = Math.floor(baseFrame / sheetCols), baseCol = baseFrame % sheetCols;
        const frameAt = (r, c) => (baseRow + r) * sheetCols + (baseCol + c);
        const animsToCreate = [
            { k: `ship_down${keySuffix}`, s: frameAt(0, 0), e: frameAt(0, 2) }, { k: `ship_down_left${keySuffix}`, s: frameAt(0, 3), e: frameAt(0, 5) },
            { k: `ship_left${keySuffix}`, s: frameAt(1, 0), e: frameAt(1, 2) }, { k: `ship_down_right${keySuffix}`, s: frameAt(1, 3), e: frameAt(1, 5) },
            { k: `ship_right${keySuffix}`, s: frameAt(2, 0), e: frameAt(2, 2) }, { k: `ship_up_left${keySuffix}`, s: frameAt(2, 3), e: frameAt(2, 5) },
            { k: `ship_up${keySuffix}`, s: frameAt(3, 0), e: frameAt(3, 2) }, { k: `ship_up_right${keySuffix}`, s: frameAt(3, 3), e: frameAt(3, 5) },
        ];
        animsToCreate.forEach(a => {
            if (!this.anims.exists(a.k)) this.anims.create({ key: a.k, frames: this.anims.generateFrameNumbers(sheet, { start: a.s, end: a.e }), frameRate: 10, repeat: -1 });
        });
        this.shipAnims[keySuffix] = {
            idleFrames: { 'ship_down': frameAt(0, 1), 'ship_down_left': frameAt(0, 4), 'ship_left': frameAt(1, 1), 'ship_down_right': frameAt(1, 4), 'ship_right': frameAt(2, 1), 'ship_up_left': frameAt(2, 4), 'ship_up': frameAt(3, 1), 'ship_up_right': frameAt(3, 4) }
        };
    }

    async initializeIslands() {
        try {
            const querySnapshot = await getDocs(collection(getFirestore(), "world_map"));
            if (querySnapshot.empty) return console.warn('[WorldMapScene] No islands found in Firestore');
            querySnapshot.forEach((docSnapshot) => {
                const data = docSnapshot.data();
                if (data.coordinate && typeof data.coordinate.x === 'number') {
                    this.createIsland({ id: docSnapshot.id, ...data, x: data.coordinate.x * this.gridSize, y: data.coordinate.y * this.gridSize });
                }
            });
        } catch (error) { console.error('[WorldMapScene] Error fetching island data:', error); }
    }

    createIsland(data) { /* ... 以前のロジック ... */ }
    createMinimap() { /* ... 以前のロジック ... */ }
    update() { /* ... 以前のロジック ... */ }

    // ... その他の全ての関数をここに含める ...
}

